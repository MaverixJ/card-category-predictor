# -*- coding: utf-8 -*-
"""Card Prediction App

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1CXsMhOeW0V6Ay8ymTwSNcAhoo8j9arYP
"""

import streamlit as st
import pandas as pd
import numpy as np
import time
import plotly.graph_objects as go
import plotly.express as px
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import LabelEncoder

# -----------------------------------------------------------------------------
# 1. PAGE SETUP
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="Card Category Intelligence",
    page_icon="ðŸ’³",
    layout="wide"
)

# Custom CSS for Dark Mode
st.markdown("""
<style>
    .stApp { background-color: #0E1117; color: #FAFAFA; }
    .metric-container {
        background-color: #262730;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        text-align: center;
        border: 1px solid #41444C;
        margin-bottom: 20px;
    }
    .big-stat { font-size: 3rem; font-weight: 800; margin: 10px 0; color: #FFFFFF; }
    .stat-label { font-size: 1.1rem; color: #B0B0B0; font-weight: 600; text-transform: uppercase; }
    .highlight-box {
        background-color: #1A1C24; color: #FAFAFA; padding: 20px;
        border-radius: 10px; border-left: 5px solid #2196f3; margin-bottom: 15px;
    }
    h1, h2, h3, h4 { color: #FAFAFA !important; }
    .css-1d391kg { color: #FAFAFA; }
</style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------------------------
# 2. INTELLIGENT DATA LOADER (WITH OVERSAMPLING)
# -----------------------------------------------------------------------------

@st.cache_data
def load_and_train_model(uploaded_file):
    """
    Reads dataset, performs AGGRESSIVE OVERSAMPLING to fix class imbalance,
    and trains the model.
    """
    df = pd.read_csv(uploaded_file)

    # 1. Basic Cleaning
    keep_cols = [
        'Customer_Age', 'Dependent_count', 'Education_Level', 'Income_Category',
        'Credit_Limit', 'Total_Revolving_Bal', 'Total_Trans_Amt',
        'Total_Trans_Ct', 'Avg_Utilization_Ratio', 'Card_Category'
    ]
    df = df[[c for c in keep_cols if c in df.columns]]

    # 2. Encoding
    income_map = {
        'Unknown': 0, 'Less than $40K': 1, '$40K - $60K': 2,
        '$60K - $80K': 3, '$80K - $120K': 4, '$120K +': 5
    }
    if 'Income_Category' in df.columns:
        df['Income_Encoded'] = df['Income_Category'].map(income_map).fillna(0)

    le_dict = {}
    if 'Education_Level' in df.columns:
        le = LabelEncoder()
        df['Education_Level_Code'] = le.fit_transform(df['Education_Level'].astype(str))
        le_dict['Education_Level'] = le

    # 3. Feature Selection
    feature_cols = [
        'Customer_Age', 'Dependent_count', 'Credit_Limit', 'Total_Revolving_Bal',
        'Total_Trans_Amt', 'Total_Trans_Ct', 'Avg_Utilization_Ratio',
        'Income_Encoded', 'Education_Level_Code'
    ]
    df_clean = df.dropna(subset=feature_cols + ['Card_Category'])

    # --- 4. AGGRESSIVE OVERSAMPLING (THE FIX) ---
    # We split the data into groups
    df_blue = df_clean[df_clean['Card_Category'] == 'Blue']
    df_silver = df_clean[df_clean['Card_Category'] == 'Silver']
    df_gold = df_clean[df_clean['Card_Category'] == 'Gold']
    df_plat = df_clean[df_clean['Card_Category'] == 'Platinum']

    # We calculate how many copies we need to match the Blue count
    target_count = len(df_blue)

    # Brute force replication
    # We sample with replacement until we reach the target count (Blue's size)
    if len(df_silver) > 0:
        df_silver_over = df_silver.sample(target_count, replace=True, random_state=42)
    else:
        df_silver_over = df_silver # Safety catch

    if len(df_gold) > 0:
        df_gold_over = df_gold.sample(target_count, replace=True, random_state=42)
    else:
        df_gold_over = df_gold

    if len(df_plat) > 0:
        df_plat_over = df_plat.sample(target_count, replace=True, random_state=42)
    else:
        df_plat_over = df_plat

    # Combine back into one balanced training set
    df_balanced = pd.concat([df_blue, df_silver_over, df_gold_over, df_plat_over], axis=0)

    # Shuffle
    df_balanced = df_balanced.sample(frac=1, random_state=42).reset_index(drop=True)

    X = df_balanced[feature_cols]
    y = df_balanced['Card_Category']

    # --- 5. TRAINING ---
    clf = RandomForestClassifier(n_estimators=100, max_depth=None, random_state=42)
    clf.fit(X, y)

    # Profiles from ORIGINAL clean data (not the oversampled one, to keep averages real)
    segment_profiles = df_clean.groupby('Card_Category')[feature_cols].mean()

    return clf, feature_cols, segment_profiles, le_dict, df_clean

# -----------------------------------------------------------------------------
# 3. SIDEBAR: CUSTOMER INPUT
# -----------------------------------------------------------------------------
st.sidebar.header("Customer Profile")
uploaded_file = st.sidebar.file_uploader("Upload DataSet.csv", type=['csv'])

if not uploaded_file:
    st.info("Please upload the `DataSet.csv` file to initialize.")
    st.stop()

model, feature_names, profiles, encoders, raw_df = load_and_train_model(uploaded_file)
st.sidebar.success("Model Trained (Balanced)!")
st.sidebar.markdown("---")

with st.sidebar.form("input_form"):
    st.subheader("Demographics")
    age = st.number_input("Age", 20, 80, 45)
    dependents = st.slider("Dependents", 0, 5, 2)
    education = st.selectbox("Education", ["Uneducated", "High School", "College", "Graduate", "Post-Graduate", "Doctorate", "Unknown"])
    income = st.select_slider("Income Range", options=['Unknown', 'Less than $40K', '$40K - $60K', '$60K - $80K', '$80K - $120K', '$120K +'], value='$60K - $80K')

    st.subheader("Financials")
    credit_limit = st.number_input("Credit Limit ($)", 1000, 50000, 30000)
    revolving_bal = st.number_input("Revolving Balance ($)", 0, 3000, 1500)
    utilization = st.slider("Utilization Ratio", 0.0, 1.0, 0.15)

    st.subheader("Behaviors (Last 12m)")
    trans_amt = st.number_input("Total Trans Amt ($)", 0, 30000, 15000)
    trans_ct = st.number_input("Total Trans Count", 0, 200, 100)

    submit = st.form_submit_button("Predict Category")

# -----------------------------------------------------------------------------
# 4. PREDICTION LOGIC
# -----------------------------------------------------------------------------
if submit:
    income_map = {'Unknown': 0, 'Less than $40K': 1, '$40K - $60K': 2, '$60K - $80K': 3, '$80K - $120K': 4, '$120K +': 5}
    try:
        edu_code = encoders['Education_Level'].transform([education])[0]
    except:
        edu_code = 0

    input_data = pd.DataFrame([{
        'Customer_Age': age,
        'Dependent_count': dependents,
        'Credit_Limit': credit_limit,
        'Total_Revolving_Bal': revolving_bal,
        'Total_Trans_Amt': trans_amt,
        'Total_Trans_Ct': trans_ct,
        'Avg_Utilization_Ratio': utilization,
        'Income_Encoded': income_map[income],
        'Education_Level_Code': edu_code
    }])

    with st.spinner("Analyzing..."):
        time.sleep(0.3)
        prediction = model.predict(input_data)[0]
        probs = model.predict_proba(input_data)
        confidence = np.max(probs) * 100

    # -------------------------------------------------------------------------
    # 5. UI: RESULTS
    # -------------------------------------------------------------------------
    st.title("Prediction Analysis")
    st.markdown("<br>", unsafe_allow_html=True)

    col1, col2 = st.columns(2)
    colors = {"Blue": "#33A1FD", "Silver": "#E0E0E0", "Gold": "#FFD700", "Platinum": "#E5E4E2"}
    p_color = colors.get(prediction, "#FFFFFF")

    with col1:
        st.markdown(f"""
        <div class="metric-container" style="border-top: 6px solid {p_color};">
            <div class="stat-label">Predicted Category</div>
            <div class="big-stat" style="color: {p_color};">{prediction}</div>
        </div>""", unsafe_allow_html=True)

    with col2:
        st.markdown(f"""
        <div class="metric-container" style="border-top: 6px solid #2ecc71;">
            <div class="stat-label">Model Confidence</div>
            <div class="big-stat">{confidence:.1f}%</div>
        </div>""", unsafe_allow_html=True)

    # DEBUG: Show probabilities
    with st.expander("Show detailed probabilities (Debugging)"):
        prob_df = pd.DataFrame(probs, columns=model.classes_)
        st.dataframe(prob_df)

    st.markdown("<br><hr>", unsafe_allow_html=True)
    st.subheader(f"ðŸ” Insight: Why {prediction}?")

    c_explain_1, c_explain_2 = st.columns([1.2, 0.8])

    with c_explain_1:
        segment_avg = profiles.loc[prediction]
        radar_metrics = ['Credit_Limit', 'Total_Trans_Amt', 'Total_Trans_Ct', 'Total_Revolving_Bal']

        def normalize(val, col_name):
            max_val = raw_df[col_name].max()
            return val / max_val if max_val > 0 else 0

        input_norm = [normalize(input_data[m].values[0], m) for m in radar_metrics]
        avg_norm = [normalize(segment_avg[m], m) for m in radar_metrics]

        fig = go.Figure()
        fig.add_trace(go.Scatterpolar(r=input_norm, theta=radar_metrics, fill='toself', name='This Customer', line_color=p_color))
        fig.add_trace(go.Scatterpolar(r=avg_norm, theta=radar_metrics, fill='toself', name=f'Avg {prediction}', line_color='#888888', line=dict(dash='dash')))

        fig.update_layout(template='plotly_dark', paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)', polar=dict(radialaxis=dict(visible=False), bgcolor='#262730'), showlegend=True, height=400)
        st.plotly_chart(fig, use_container_width=True)

    with c_explain_2:
        st.markdown(f"##### Key Drivers for {prediction}")
        explanations = []
        if prediction in ["Gold", "Platinum"]:
            if input_data['Total_Trans_Amt'].values[0] > 7000:
                explanations.append(f"**High Transaction Volume**<br>${input_data['Total_Trans_Amt'].values[0]:,.0f} spend is a key premium indicator.")
            if input_data['Credit_Limit'].values[0] > 15000:
                explanations.append(f"**High Credit Limit**<br>${input_data['Credit_Limit'].values[0]:,.0f} limit aligns with premium tiers.")
        elif prediction == "Blue":
            explanations.append("**Standard Usage**<br>Metrics fall within the standard consumer range.")

        if explanations:
            for exp in explanations:
                st.markdown(f"<div class='highlight-box'>{exp}</div>", unsafe_allow_html=True)
        else:
            st.markdown(f"<div class='highlight-box'>Profile matches standard {prediction} behavior.</div>", unsafe_allow_html=True)

else:
    st.markdown("""<div style='text-align: center; padding: 50px; background-color: #262730; border-radius: 10px;'><h2>Waiting for Input...</h2><p style='color:#B0B0B0'>Upload DataSet.csv to begin.</p></div>""", unsafe_allow_html=True)