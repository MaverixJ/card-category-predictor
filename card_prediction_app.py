# -*- coding: utf-8 -*-
"""Card Prediction App

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1SCOK7fOXzLaLTF3zmS2925eJMU-af1UM
"""

import streamlit as st
import pandas as pd
import numpy as np
import time
import plotly.graph_objects as go
import plotly.express as px
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import LabelEncoder

# -----------------------------------------------------------------------------
# 1. PAGE SETUP
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="Card Category Intelligence",
    page_icon="ðŸ’³",
    layout="wide"
)

# Custom CSS for the "Ace3" look (clean cards, metric values)
st.markdown("""
<style>
    .stApp { background-color: #f4f6f9; }
    .metric-container {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        text-align: center;
        border-top: 4px solid #ddd;
    }
    .big-stat { font-size: 2.5rem; font-weight: 700; margin: 0; }
    .stat-label { font-size: 1rem; color: #6c757d; text-transform: uppercase; letter-spacing: 1px; }
    .insight-box {
        background-color: #e3f2fd;
        border-left: 5px solid #2196f3;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
    }
</style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------------------------
# 2. INTELLIGENT DATA LOADER
# -----------------------------------------------------------------------------

@st.cache_data
def load_and_train_model(uploaded_file):
    """
    Reads the specific structure of DataSet.csv, trains a model,
    and calculates segment averages for the 'Why' analysis.
    """
    # Load Data
    df = pd.read_csv(uploaded_file)

    # --- 1. CLEANING & ENCODING ---
    # We select the most impactful features for classification
    # (ignoring Naive_Bayes columns and generic IDs)
    keep_cols = [
        'Customer_Age', 'Dependent_count', 'Education_Level', 'Income_Category',
        'Credit_Limit', 'Total_Revolving_Bal', 'Total_Trans_Amt',
        'Total_Trans_Ct', 'Avg_Utilization_Ratio', 'Card_Category'
    ]

    # Filter only existing columns (safety check)
    df = df[[c for c in keep_cols if c in df.columns]]

    # Ordinal Mapping for Income (Crucial for accuracy)
    income_map = {
        'Unknown': 0, 'Less than $40K': 1, '$40K - $60K': 2,
        '$60K - $80K': 3, '$80K - $120K': 4, '$120K +': 5
    }
    if 'Income_Category' in df.columns:
        df['Income_Encoded'] = df['Income_Category'].map(income_map).fillna(0)

    # Label Encoding for categorical text (Education, etc.)
    le_dict = {}
    cat_cols = ['Education_Level']
    for col in cat_cols:
        if col in df.columns:
            le = LabelEncoder()
            df[col + '_Code'] = le.fit_transform(df[col].astype(str))
            le_dict[col] = le

    # Define Features (X) and Target (y)
    # We use the numerical versions of the columns
    feature_cols = [
        'Customer_Age', 'Dependent_count', 'Credit_Limit', 'Total_Revolving_Bal',
        'Total_Trans_Amt', 'Total_Trans_Ct', 'Avg_Utilization_Ratio',
        'Income_Encoded', 'Education_Level_Code'
    ]

    # Drop rows with missing values in these specific columns
    df_clean = df.dropna(subset=feature_cols + ['Card_Category'])

    X = df_clean[feature_cols]
    y = df_clean['Card_Category']

    # --- 2. TRAINING ---
    # RandomForest is excellent for this tabular data
    clf = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)
    clf.fit(X, y)

    # --- 3. SEGMENT PROFILING (For "The Why") ---
    # Calculate the average profile for Blue, Silver, Gold, Platinum
    segment_profiles = df_clean.groupby('Card_Category')[feature_cols].mean()

    return clf, feature_cols, segment_profiles, le_dict, df_clean

# -----------------------------------------------------------------------------
# 3. SIDEBAR: CUSTOMER INPUT
# -----------------------------------------------------------------------------
st.sidebar.header("Customer Profile")

# File Uploader
uploaded_file = st.sidebar.file_uploader("Upload DataSet.csv", type=['csv'])

if not uploaded_file:
    st.info("Please upload the `DataSet.csv` file to initialize the AI.")
    st.stop()

# Train/Load (Cached)
model, feature_names, profiles, encoders, raw_df = load_and_train_model(uploaded_file)
st.sidebar.success("Model Trained on Uploaded Data!")
st.sidebar.markdown("---")

# Input Form
with st.sidebar.form("input_form"):
    st.subheader("Demographics")
    age = st.number_input("Age", 20, 80, 45)
    dependents = st.slider("Dependents", 0, 5, 2)
    education = st.selectbox("Education", ["Uneducated", "High School", "College", "Graduate", "Post-Graduate", "Doctorate", "Unknown"])
    income = st.select_slider("Income Range", options=['Unknown', 'Less than $40K', '$40K - $60K', '$60K - $80K', '$80K - $120K', '$120K +'], value='$60K - $80K')

    st.subheader("Financials")
    credit_limit = st.number_input("Credit Limit ($)", 1000, 40000, 8500)
    revolving_bal = st.number_input("Revolving Balance ($)", 0, 3000, 1000)
    utilization = st.slider("Utilization Ratio", 0.0, 1.0, 0.15)

    st.subheader("Behaviors (Last 12m)")
    trans_amt = st.number_input("Total Trans Amt ($)", 0, 20000, 4000)
    trans_ct = st.number_input("Total Trans Count", 0, 150, 70)

    submit = st.form_submit_button("Predict Category")

# -----------------------------------------------------------------------------
# 4. PREDICTION LOGIC
# -----------------------------------------------------------------------------
if submit:
    # Prepare Input Vector (must match training order)
    income_map = {'Unknown': 0, 'Less than $40K': 1, '$40K - $60K': 2, '$60K - $80K': 3, '$80K - $120K': 4, '$120K +': 5}

    # Handle Education Encoding safely
    try:
        edu_code = encoders['Education_Level'].transform([education])[0]
    except:
        edu_code = 0 # Default if unseen

    input_data = pd.DataFrame([{
        'Customer_Age': age,
        'Dependent_count': dependents,
        'Credit_Limit': credit_limit,
        'Total_Revolving_Bal': revolving_bal,
        'Total_Trans_Amt': trans_amt,
        'Total_Trans_Ct': trans_ct,
        'Avg_Utilization_Ratio': utilization,
        'Income_Encoded': income_map[income],
        'Education_Level_Code': edu_code
    }]) # Order matters!

    # Predict
    with st.spinner("Analyzing patterns..."):
        time.sleep(0.4) # UI smoothness
        prediction = model.predict(input_data)[0]
        probs = model.predict_proba(input_data)
        confidence = np.max(probs) * 100

    # -------------------------------------------------------------------------
    # 5. UI: RESULTS & EXPLANATION
    # -------------------------------------------------------------------------

    st.title("Prediction Analysis")

    # --- Top Cards ---
    col1, col2, col3 = st.columns(3)

    # Dynamic Colors
    colors = {"Blue": "#1f77b4", "Silver": "#7f7f7f", "Gold": "#ff7f0e", "Platinum": "#000000"}
    p_color = colors.get(prediction, "#333")

    with col1:
        st.markdown(f"""
        <div class="metric-container" style="border-color: {p_color};">
            <div class="stat-label">Predicted Category</div>
            <div class="big-stat" style="color: {p_color};">{prediction}</div>
        </div>
        """, unsafe_allow_html=True)

    with col2:
        st.markdown(f"""
        <div class="metric-container" style="border-color: {p_color};">
            <div class="stat-label">Confidence Score</div>
            <div class="big-stat">{confidence:.1f}%</div>
        </div>
        """, unsafe_allow_html=True)

    with col3:
        # Determine Next Best Action
        if prediction == "Platinum":
            action = "Offer Premium Concierge"
        elif prediction == "Gold":
            action = "Upsell Travel Rewards"
        elif prediction == "Blue":
            action = "Increase Credit Limit"
        else:
            action = "Retention Offer"

        st.markdown(f"""
        <div class="metric-container" style="border-color: {p_color};">
            <div class="stat-label">Recommended Action</div>
            <div class="big-stat" style="font-size: 1.8rem;">{action}</div>
        </div>
        """, unsafe_allow_html=True)

    # --- THE "WHY" SECTION ---
    st.markdown("---")
    st.header(f"Why was this customer classified as {prediction}?")

    c_explain_1, c_explain_2 = st.columns([1, 1])

    with c_explain_1:
        st.subheader("Feature Comparison")
        # Compare Input vs Average of Predicted Segment
        segment_avg = profiles.loc[prediction]

        # Select key metrics for Radar Chart
        radar_metrics = ['Credit_Limit', 'Total_Trans_Amt', 'Total_Trans_Ct', 'Total_Revolving_Bal']

        # We normalize values to 0-1 scale relative to the max in the dataset for visualization
        # (Simplified normalization for visual comparison)
        def normalize(val, col_name):
            max_val = raw_df[col_name].max()
            return val / max_val if max_val > 0 else 0

        input_norm = [normalize(input_data[m].values[0], m) for m in radar_metrics]
        avg_norm = [normalize(segment_avg[m], m) for m in radar_metrics]

        fig = go.Figure()
        fig.add_trace(go.Scatterpolar(r=input_norm, theta=radar_metrics, fill='toself', name='This Customer'))
        fig.add_trace(go.Scatterpolar(r=avg_norm, theta=radar_metrics, fill='toself', name=f'Avg {prediction}'))
        fig.update_layout(polar=dict(radialaxis=dict(visible=False)), showlegend=True, height=350)
        st.plotly_chart(fig, use_container_width=True)

    with c_explain_2:
        st.subheader("Key Drivers")

        # Calculate Logic
        diff_trans = input_data['Total_Trans_Amt'].values[0] - segment_avg['Total_Trans_Amt']
        diff_limit = input_data['Credit_Limit'].values[0] - segment_avg['Credit_Limit']

        # Generate Explanation Text
        explanations = []
        if prediction in ["Gold", "Platinum"]:
            if input_data['Total_Trans_Amt'].values[0] > 8000:
                explanations.append(f"âœ… **High Transaction Volume**: ${input_data['Total_Trans_Amt'].values[0]:,.0f} is a strong indicator for Premium tiers.")
            if input_data['Credit_Limit'].values[0] > 15000:
                explanations.append(f"âœ… **High Credit Limit**: Access to ${input_data['Credit_Limit'].values[0]:,.0f} credit aligns with {prediction} profiles.")

        elif prediction == "Blue":
            if input_data['Total_Trans_Amt'].values[0] < 5000:
                explanations.append(f"â„¹ï¸ **Moderate Spending**: Transaction volume is typical for the Blue entry-tier.")
            if input_data['Credit_Limit'].values[0] < 10000:
                explanations.append(f"â„¹ï¸ **Standard Credit Limit**: Limit fits the standard profile.")

        # Show explanations
        if explanations:
            for exp in explanations:
                st.markdown(exp)
        else:
            st.write("This customer's profile matches the standard characteristics of this segment across all dimensions.")

        st.info("The Radar chart (left) shows how this customer compares to the 'Ideal' or 'Average' customer in the predicted category.")

else:
    # Default State (Instruction)
    st.markdown("""
    <div style='text-align: center; padding: 50px; color: #666;'>
        <h2>waiting for input...</h2>
        <p>Upload the <b>DataSet.csv</b> in the sidebar, fill out the customer form, and click <b>Predict Category</b>.</p>
    </div>
    """, unsafe_allow_html=True)